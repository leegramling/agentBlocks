<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentBlocks Desktop</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: Inter, system-ui, Avenir, Helvetica, Arial, sans-serif;
            background-color: #111827;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        .layout {
            background-color: #111827;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .menu-bar {
            background-color: #1f2937;
            border-bottom: 1px solid #374151;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 48px;
        }

        .app-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
        }

        .menu-buttons {
            display: flex;
            gap: 8px;
        }

        .menu-button {
            background-color: #374151;
            border: none;
            color: #d1d5db;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .menu-button:hover {
            background-color: #4b5563;
            color: #ffffff;
        }

        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .block-palette {
            width: 280px;
            background-color: #1f2937;
            border-right: 1px solid #374151;
            display: flex;
            flex-direction: column;
            padding: 16px;
        }

        .palette-title {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 16px;
        }

        .palette-block {
            background-color: #374151;
            border: 1px solid #4b5563;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .palette-block:hover {
            background-color: #4b5563;
            border-color: #6b7280;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .block-name {
            color: #ffffff;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .block-description {
            color: #9ca3af;
            font-size: 11px;
            line-height: 1.3;
        }

        .canvas-area {
            flex: 1;
            background-color: #111827;
            position: relative;
            overflow: auto;
        }

        .canvas-content {
            position: relative;
            width: 200%;
            height: 200%;
            min-width: 1600px;
            min-height: 1200px;
            background-image: 
                linear-gradient(rgba(75, 85, 99, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(75, 85, 99, 0.2) 1px, transparent 1px);
            background-size: 25px 25px;
        }

        .workflow-node {
            position: absolute;
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-radius: 6px;
            border-left: 3px solid;
            cursor: move;
            transition: all 0.2s;
            min-height: 44px;
            width: 220px;
            background: #1e293b;
            user-select: none;
        }

        .workflow-node:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .workflow-node.selected {
            box-shadow: 0 0 0 2px #06b6d4;
        }

        .node-icon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            font-weight: bold;
        }

        .node-content {
            flex: 1;
        }

        .node-title {
            font-weight: 500;
            font-size: 13px;
            margin-bottom: 2px;
            color: #f8fafc;
        }

        .node-subtitle {
            font-size: 11px;
            color: #94a3b8;
            line-height: 1.3;
        }

        /* Variable node styling */
        .workflow-node[data-type="variable"] { 
            border-left-color: #f59e0b; 
            background: rgba(245, 158, 11, 0.1); 
        }
        .workflow-node[data-type="variable"] .node-icon { 
            background: #f59e0b; 
        }

        /* Print node styling */
        .workflow-node[data-type="print"] { 
            border-left-color: #10b981; 
            background: rgba(16, 185, 129, 0.1); 
        }
        .workflow-node[data-type="print"] .node-icon { 
            background: #10b981; 
        }

        .properties-panel {
            width: 320px;
            background-color: #1f2937;
            border-left: 1px solid #374151;
            padding: 16px;
            overflow-y: auto;
        }

        .panel-title {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 16px;
        }

        .property-group {
            margin-bottom: 16px;
        }

        .property-label {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 4px;
            display: block;
        }

        .property-input {
            width: 100%;
            background-color: #374151;
            border: 1px solid #4b5563;
            border-radius: 4px;
            padding: 8px;
            color: #ffffff;
            font-size: 14px;
        }

        .property-input:focus {
            outline: none;
            border-color: #2563eb;
        }

        .execution-panel {
            background-color: #1f2937;
            border-top: 1px solid #374151;
            padding: 16px;
            height: 200px;
            display: flex;
            flex-direction: column;
        }

        .execution-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .execution-title {
            font-size: 12px;
            font-weight: 600;
            color: #e2e8f0;
        }

        .execute-button {
            background-color: #059669;
            border: none;
            color: #ffffff;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .execute-button:hover {
            background-color: #047857;
        }

        .execution-output {
            flex: 1;
            background-color: #0f172a;
            border: 1px solid #374151;
            border-radius: 4px;
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #e2e8f0;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .canvas-tooltip {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(31, 41, 55, 0.9);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 12px 16px;
            color: #d1d5db;
            font-size: 14px;
            max-width: 300px;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div class="layout">
        <!-- Menu Bar -->
        <div class="menu-bar">
            <h1 class="app-title">AgentBlocks Desktop</h1>
            <div class="menu-buttons">
                <button class="menu-button" onclick="saveWorkflow()">Save</button>
                <button class="menu-button" onclick="loadWorkflow()">Load</button>
                <button class="menu-button" onclick="newWorkflow()">New</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Block Palette -->
            <div class="block-palette">
                <div class="palette-title">üì¶ Blocks</div>
                
                <div class="palette-block" draggable="true" data-type="variable">
                    <div class="block-name">üì¶ Variable</div>
                    <div class="block-description">Store and retrieve values</div>
                </div>

                <div class="palette-block" draggable="true" data-type="print">
                    <div class="block-name">üñ®Ô∏è Print</div>
                    <div class="block-description">Output text to console</div>
                </div>
            </div>

            <!-- Canvas Area -->
            <div class="canvas-area" id="canvas-area">
                <div class="canvas-content" id="canvas-content">
                    <div class="canvas-tooltip" id="canvas-tooltip">
                        üí° <strong>Tip:</strong> Drag blocks from the left panel to start creating your workflow. Try adding a Variable block followed by a Print block!
                    </div>
                </div>
            </div>

            <!-- Properties Panel -->
            <div class="properties-panel">
                <div class="panel-title">‚öôÔ∏è Properties</div>
                <div id="properties-content">
                    <p style="color: #9ca3af; text-align: center; margin-top: 32px;">
                        Select a node to edit its properties
                    </p>
                </div>
            </div>
        </div>

        <!-- Execution Panel -->
        <div class="execution-panel">
            <div class="execution-header">
                <div class="execution-title">üñ•Ô∏è Execution Log</div>
                <button class="execute-button" onclick="executeWorkflow()">‚ñ∂ Run Workflow</button>
            </div>
            <div class="execution-output" id="execution-output">Ready to execute workflow...\n</div>
        </div>
    </div>

    <script>
        // Include Tauri API
        const { invoke } = window.__TAURI__.tauri;

        // Application state
        let currentWorkflow = null;
        let selectedNode = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };

        // Initialize app
        async function initApp() {
            try {
                currentWorkflow = await invoke('create_workflow', { name: 'Untitled Workflow' });
                setupEventListeners();
                updateCanvasTooltip();
            } catch (error) {
                console.error('Failed to initialize app:', error);
            }
        }

        function setupEventListeners() {
            // Canvas drop handling
            const canvasArea = document.getElementById('canvas-area');
            const canvasContent = document.getElementById('canvas-content');

            canvasArea.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            canvasArea.addEventListener('drop', async (e) => {
                e.preventDefault();
                const blockType = e.dataTransfer.getData('blockType');
                if (!blockType) return;

                const rect = canvasContent.getBoundingClientRect();
                const position = {
                    x: e.clientX - rect.left - 110, // Center the node
                    y: e.clientY - rect.top - 22
                };

                try {
                    currentWorkflow = await invoke('add_node', {
                        workflow: currentWorkflow,
                        nodeType: blockType,
                        position: position
                    });
                    renderWorkflow();
                    updateCanvasTooltip();
                } catch (error) {
                    console.error('Failed to add node:', error);
                }
            });

            // Palette drag handling
            document.querySelectorAll('.palette-block').forEach(block => {
                block.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('blockType', block.dataset.type);
                });
            });
        }

        function renderWorkflow() {
            const canvasContent = document.getElementById('canvas-content');
            
            // Clear existing nodes
            canvasContent.querySelectorAll('.workflow-node').forEach(node => node.remove());

            if (!currentWorkflow || !currentWorkflow.nodes) return;

            // Render nodes
            currentWorkflow.nodes.forEach(node => {
                const nodeElement = createNodeElement(node);
                canvasContent.appendChild(nodeElement);
            });
        }

        function createNodeElement(node) {
            const nodeDiv = document.createElement('div');
            nodeDiv.className = 'workflow-node';
            nodeDiv.dataset.type = node.node_type;
            nodeDiv.dataset.nodeId = node.id;
            nodeDiv.style.left = `${node.position.x}px`;
            nodeDiv.style.top = `${node.position.y}px`;

            const icon = node.node_type === 'variable' ? 'üì¶' : 'üñ®Ô∏è';
            const title = node.node_type.charAt(0).toUpperCase() + node.node_type.slice(1);
            
            let subtitle = '';
            if (node.node_type === 'variable') {
                const name = node.properties.name || 'myVariable';
                const value = node.properties.value || 'hello world';
                subtitle = `${name}: "${value}"`;
            } else if (node.node_type === 'print') {
                const message = node.properties.message || 'myVariable';
                subtitle = `Print: ${message}`;
            }

            nodeDiv.innerHTML = `
                <div class="node-icon">${icon}</div>
                <div class="node-content">
                    <div class="node-title">${title}</div>
                    <div class="node-subtitle">${subtitle}</div>
                </div>
            `;

            // Add event listeners
            nodeDiv.addEventListener('mousedown', (e) => handleNodeMouseDown(e, node));
            nodeDiv.addEventListener('click', () => selectNode(node));

            return nodeDiv;
        }

        function handleNodeMouseDown(e, node) {
            if (e.detail === 2) return; // Ignore double clicks

            isDragging = true;
            selectedNode = node;
            
            const nodeRect = e.currentTarget.getBoundingClientRect();
            const canvasRect = document.getElementById('canvas-content').getBoundingClientRect();
            
            dragOffset = {
                x: e.clientX - canvasRect.left - node.position.x,
                y: e.clientY - canvasRect.top - node.position.y
            };

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }

        async function handleMouseMove(e) {
            if (!isDragging || !selectedNode) return;

            const canvasRect = document.getElementById('canvas-content').getBoundingClientRect();
            const newPosition = {
                x: e.clientX - canvasRect.left - dragOffset.x,
                y: e.clientY - canvasRect.top - dragOffset.y
            };

            try {
                currentWorkflow = await invoke('update_node_position', {
                    workflow: currentWorkflow,
                    nodeId: selectedNode.id,
                    position: newPosition
                });
                
                // Update node position immediately for smooth dragging
                const nodeElement = document.querySelector(`[data-node-id="${selectedNode.id}"]`);
                if (nodeElement) {
                    nodeElement.style.left = `${newPosition.x}px`;
                    nodeElement.style.top = `${newPosition.y}px`;
                }
                
                // Update selectedNode position
                selectedNode.position = newPosition;
            } catch (error) {
                console.error('Failed to update node position:', error);
            }
        }

        function handleMouseUp() {
            isDragging = false;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        }

        function selectNode(node) {
            selectedNode = node;
            
            // Update visual selection
            document.querySelectorAll('.workflow-node').forEach(n => n.classList.remove('selected'));
            const nodeElement = document.querySelector(`[data-node-id="${node.id}"]`);
            if (nodeElement) nodeElement.classList.add('selected');
            
            // Update properties panel
            updatePropertiesPanel(node);
        }

        function updatePropertiesPanel(node) {
            const propertiesContent = document.getElementById('properties-content');
            
            if (node.node_type === 'variable') {
                propertiesContent.innerHTML = `
                    <div class="property-group">
                        <label class="property-label">Variable Name</label>
                        <input type="text" class="property-input" value="${node.properties.name || 'myVariable'}" 
                               onchange="updateNodeProperty('name', this.value)">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Value</label>
                        <input type="text" class="property-input" value="${node.properties.value || 'hello world'}" 
                               onchange="updateNodeProperty('value', this.value)">
                    </div>
                `;
            } else if (node.node_type === 'print') {
                propertiesContent.innerHTML = `
                    <div class="property-group">
                        <label class="property-label">Message</label>
                        <input type="text" class="property-input" value="${node.properties.message || 'myVariable'}" 
                               onchange="updateNodeProperty('message', this.value)">
                    </div>
                `;
            }
        }

        async function updateNodeProperty(key, value) {
            if (!selectedNode) return;

            const newProperties = { ...selectedNode.properties };
            newProperties[key] = value;

            try {
                currentWorkflow = await invoke('update_node_properties', {
                    workflow: currentWorkflow,
                    nodeId: selectedNode.id,
                    properties: newProperties
                });
                
                // Update local node
                selectedNode.properties = newProperties;
                
                // Re-render to update subtitle
                renderWorkflow();
                selectNode(selectedNode); // Maintain selection
            } catch (error) {
                console.error('Failed to update node properties:', error);
            }
        }

        async function executeWorkflow() {
            if (!currentWorkflow || currentWorkflow.nodes.length === 0) {
                appendToOutput('Error: No nodes to execute\n');
                return;
            }

            appendToOutput('=== Execution Started ===\n');

            try {
                const result = await invoke('execute_workflow', { workflow: currentWorkflow });
                
                if (result.success) {
                    appendToOutput('Execution completed successfully:\n');
                    appendToOutput(result.output);
                } else {
                    appendToOutput('Execution failed:\n');
                    if (result.error) {
                        appendToOutput(`Error: ${result.error}\n`);
                    }
                    appendToOutput('Generated code:\n');
                    appendToOutput(result.output);
                }
            } catch (error) {
                appendToOutput(`Error: ${error}\n`);
            }

            appendToOutput('=== Execution Completed ===\n');
        }

        function appendToOutput(text) {
            const output = document.getElementById('execution-output');
            output.textContent += text;
            output.scrollTop = output.scrollHeight;
        }

        async function saveWorkflow() {
            if (!currentWorkflow) return;

            try {
                const path = await window.__TAURI__.dialog.save({
                    filters: [{
                        name: 'AgentBlocks Workflow',
                        extensions: ['json']
                    }]
                });

                if (path) {
                    await invoke('save_workflow', { workflow: currentWorkflow, path });
                    appendToOutput(`Workflow saved to: ${path}\n`);
                }
            } catch (error) {
                console.error('Failed to save workflow:', error);
                appendToOutput(`Error saving workflow: ${error}\n`);
            }
        }

        async function loadWorkflow() {
            try {
                const selected = await window.__TAURI__.dialog.open({
                    filters: [{
                        name: 'AgentBlocks Workflow',
                        extensions: ['json']
                    }]
                });

                if (selected) {
                    currentWorkflow = await invoke('load_workflow', { path: selected });
                    renderWorkflow();
                    updateCanvasTooltip();
                    appendToOutput(`Workflow loaded from: ${selected}\n`);
                }
            } catch (error) {
                console.error('Failed to load workflow:', error);
                appendToOutput(`Error loading workflow: ${error}\n`);
            }
        }

        async function newWorkflow() {
            try {
                currentWorkflow = await invoke('create_workflow', { name: 'Untitled Workflow' });
                selectedNode = null;
                renderWorkflow();
                updateCanvasTooltip();
                document.getElementById('properties-content').innerHTML = `
                    <p style="color: #9ca3af; text-align: center; margin-top: 32px;">
                        Select a node to edit its properties
                    </p>
                `;
                appendToOutput('New workflow created\n');
            } catch (error) {
                console.error('Failed to create new workflow:', error);
            }
        }

        function updateCanvasTooltip() {
            const tooltip = document.getElementById('canvas-tooltip');
            if (currentWorkflow && currentWorkflow.nodes.length > 0) {
                tooltip.style.display = 'none';
            } else {
                tooltip.style.display = 'block';
            }
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>